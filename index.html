<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escape The Scam | UEH</title>
    
    <link href="Content/style.css" rel="stylesheet" /> 
    <link href="Content/cert.css" rel="stylesheet" /> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="icon" type="image/png" href="Content/favicon.png"> 
    
    <style>
        /* Chống lỗi thao tác trên mobile & Tối ưu hóa rendering */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Giúp game phản hồi nhanh hơn, đặc biệt khi xoay ngang */
            touch-action: pan-y; 
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div id="login-container">
            <div id="login-info" class="login-column">
                <img id="ueh-logo" src="Content/logo/KQM.png" alt="Logo" onerror="this.src='https://placehold.co/150x50/0a0a0a/ffffff?text=Logo+Error'">
                <h3>Đăng Nhập vào "Escape The Scam"</h3>
                
            </div>
            <div id="login-box" class="login-column">
                <h2>BẮT ĐẦU HÀNH TRÌNH</h2>
                <p>Vui lòng nhập thông tin (UEH Student)</p>
                <input type="text" id="input-name" placeholder="Họ và tên..." autocomplete="off">
                <input type="text" id="input-mssv" placeholder="MSSV..." autocomplete="off">
                <button id="login-button">Tiếp tục</button>
            </div>
        </div>
    </div>

    <div id="story-intro-container">
        </div>

    <div id="game" class="hidden">
        <div id="world"></div>
        <div id="coinNumber" class="gauge">0</div>
        <div id="coin" class="gaugeSprite"></div>
        <div id="liveNumber" class="gauge">0</div>
        <div id="live" class="gaugeSprite"></div>
        <div id="playerName" class="gauge gauge-text"></div>
        <div id="playerMSSV" class="gauge gauge-text"></div>
        <div id="game-timer-display" class="gauge gauge-text" style="right: 15px; top: 15px; font-size: 1.8em; width: auto;">10:00</div>
        <div id="penalty-notification" class="gauge gauge-text hidden">
            -2:00 PHẠT THỜI GIAN!
        </div>
    </div>

    <div id="quiz-overlay" class="hidden">
        <div id="quiz-box">
            <p id="quiz-question">Đây là câu hỏi?</p>
            <div id="quiz-options">
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
                <button class="quiz-option-btn"></button>
            </div>
            <p id="quiz-explanation" class="hidden"></p>
            <button id="quiz-continue-btn" class="hidden">Tiếp tục</button>
        </div>
    </div>

    <div id="mobile-controls" class="hidden">
        <div id="dpad">
            <button id="btn-left">◀</button>
            <button id="btn-right">▶</button>
        </div>
        <div id="action-buttons">
            <button id="btn-jump">Ⓐ</button>
            <button id="btn-down">Ⓑ</button>
        </div>
    </div>
    
    <div id="certificate-screen" class="hidden">
        <div id="cert-box">
            <h2>🎉 HOÀN THÀNH XUẤT SẮC! 🎉</h2>
            <p>Xin chúc mừng bạn đã vượt qua tất cả các cạm bẫy lừa đảo và hoàn thành trò chơi!</p>
            
            <div id="cert-time" class="cert-info" style="color: #ffc107;">
                <strong>Thời gian hoàn thành</strong>
            </div>

            <p>Trường **Đại học Kinh tế TP. Hồ Chí Minh** xác nhận sinh viên:</p>
            <div id="cert-name" class="cert-info">
                <strong>Họ và tên</strong>
            </div>
            <div id="cert-mssv" class="cert-info">
                <strong>MSSV</strong>
            </div>
            <p style="font-size: 1.1em; margin-top: 25px;">đã đạt được chứng nhận **"Chiến Binh Chống Lừa Đảo"**.</p>
            <p style="margin-top: 30px; font-size: 1.2em; font-weight: bold;">Cảm ơn bạn đã tham gia!</p>
            <button id="replay-button" onclick="window.location.reload()">Chơi Lại</button>
        </div>
    </div>

    <audio id="game-music" loop>
        <source src="Content/audio/background-music.mp3" type="audio/mpeg"> 
        Trình duyệt của bạn không hỗ trợ âm thanh.
    </audio>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="Scripts/jQuery.js"><\/script>')</script>
    
    <script src="Scripts/oop.js"></script> 
    <script src="Scripts/constants.js"></script> 
    <script src="Scripts/questions.js"></script> 
    
    <script src="Scripts/main.js"></script> 
    
    <script src="Scripts/testlevels.js"></script> 
    <script src="Scripts/keys.js"></script> 
    
    <script src="Scripts/intro.js"></script>
    
    <script>
        // --- KHAI BÁO BIẾN TOÀN CỤC JS (TIMER/FLOW) ---
        var level = null; 
        let startTime = null;
        let gameTimeRemaining = 600; // 10 phút = 600 giây
        let timerInterval = null;
        const PENALTY_SECONDS = 120; // 2 phút

        // --- CÁC HÀM HỖ TRỢ TIMER ---
        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function calculateTimePlayed(startTime) {
            if (!startTime) return "N/A";
            const durationMs = Date.now() - startTime;
            const totalSeconds = Math.floor(durationMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((durationMs % 1000) / 10); // 2 chữ số
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
        }

        function updateTimerUI(timeInSeconds) {
            const timerElement = document.getElementById('game-timer-display');
            if (timerElement) {
                timerElement.textContent = formatTime(timeInSeconds);
                // Màu cảnh báo
                timerElement.style.color = (timeInSeconds <= 60 && timeInSeconds > 0) ? '#ff3b30' : 'white';
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (gameTimeRemaining > 0) {
                    gameTimeRemaining--;
                    updateTimerUI(gameTimeRemaining);
                } else {
                    clearInterval(timerInterval);
                    if (window.level && window.level.active) {
                        window.handleGameOver(false); // Game Over do hết giờ
                    }
                }
            }, 1000);
        }

        // --- HÀM XỬ LÝ PHẠT (Gọi từ Quiz Logic) ---
        window.applyTimePenalty = function() {
            gameTimeRemaining -= PENALTY_SECONDS; 
            if (gameTimeRemaining <= 0) {
                gameTimeRemaining = 0;
                clearInterval(timerInterval);
                window.handleGameOver(false); 
            }
            updateTimerUI(gameTimeRemaining);
            
            // Hiệu ứng Penalty Notification
            const penaltyNotif = document.getElementById('penalty-notification');
            if (penaltyNotif) {
                penaltyNotif.classList.remove('hidden');
                setTimeout(() => {
                    penaltyNotif.classList.add('hidden');
                }, 1500); // Hiển thị 1.5 giây
            }
        }
        
        // --- FLOW LOGIC (SỬ DỤNG JQUERY CHO TỐC ĐỘ) ---
        document.addEventListener('DOMContentLoaded', function() {
            
            const loginScreen = document.getElementById('login-screen');
            const gameDiv = document.getElementById('game');
            const gameMusic = document.getElementById('game-music'); 
            const inputName = document.getElementById('input-name');
            const inputMssv = document.getElementById('input-mssv');
            const playerNameDiv = document.getElementById('playerName');
            const playerMSSVDiv = document.getElementById('playerMSSV');
            const controls = document.getElementById('mobile-controls');
            const quizOverlay = document.getElementById('quiz-overlay');
            const quizOptionsDiv = document.getElementById('quiz-options');
            const quizOptionBtns = quizOptionsDiv.getElementsByClassName('quiz-option-btn');

            let currentLevelRef = null; 
            let currentMarioRef = null; 
            let currentCorrectAnswerIndex = -1;
            const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            
            // --- Hàm khởi tạo Game Session thực tế ---
            window.startGameSession = function() {
                 if (typeof initGame !== 'function') {
                    console.error("Lỗi: initGame() không được định nghĩa.");
                    return;
                 }
                 
                 // Fade out Intro Screen (đã được xử lý trong intro.js)
                 gameDiv.classList.remove('hidden'); 
                 gameDiv.style.opacity = '1'; 
                 
                 initGame(); 
                 currentLevelRef = window.level; 
                 if (currentLevelRef) {
                     currentMarioRef = currentLevelRef.figures.find(fig => fig instanceof Mario);
                 }

                 startTime = Date.now(); // Bắt đầu tính thời gian thực
                 startTimer();           // Bắt đầu đếm ngược 10 phút
                 
                 gameMusic.play().catch(e => console.warn("Audio play failed, requires user interaction.")); 
                 if (isTouchDevice) { controls.classList.remove('hidden'); }
                 
                 if (typeof scaleGame === 'function') {
                     scaleGame(); 
                     setTimeout(scaleGame, 50); 
                 } else {
                     console.warn("scaleGame function not found.");
                 }
            }

            // --- Handler: Login -> Intro ---
            document.getElementById('login-button').addEventListener('click', function() {
                const name = inputName.value.trim();
                const mssv = inputMssv.value.trim();
                if (name === '' || mssv === '') {
                    loginScreen.classList.add('input-error');
                    setTimeout(() => { loginScreen.classList.remove('input-error'); }, 300);
                    return;
                }
                
                // Lưu thông tin & Cập nhật UI
                localStorage.setItem('playerName', name); 
                localStorage.setItem('playerMSSV', mssv);
                playerNameDiv.textContent = name; 
                playerMSSVDiv.textContent = mssv;
                
                // Load Intro HTML và chuyển màn
                if (typeof window.loadIntroScreen === 'function') {
                    loginScreen.style.opacity = '0'; 
                    setTimeout(() => {
                        loginScreen.classList.add('hidden'); 
                        window.loadIntroScreen(); // Gọi hàm load Intro từ intro.js
                    }, 400); 
                } else {
                    console.error("Lỗi: Scripts/intro.js chưa được load hoặc hàm loadIntroScreen không tồn tại.");
                }
            });


            // --- Quiz Functions (Sửa lỗi: Dùng applyTimePenalty và Hurt) ---
            window.showQuiz = function(questionIndex, questionBoxRef) {
                 // ... (Logic tìm ref, pause game, unbind keys) ...
                 // Cần tìm lại currentLevelRef và currentMarioRef vì chúng có thể đã thay đổi sau khi load level
                 currentLevelRef = questionBoxRef.level; 
                 currentMarioRef = currentLevelRef.figures.find(fig => fig instanceof Mario);
                 
                 if (currentLevelRef) currentLevelRef.pause();
                 keys.reset(); keys.unbind(); 
                 // ... (Logic load questionData, hiển thị quiz box) ...
                 
                 const questionData = gameQuestions[questionIndex];
                 currentCorrectAnswerIndex = questionData.correct;
                 
                 // ... (Điền câu hỏi, options, v.v. - Giữ nguyên logic này) ...

                 quizOverlay.classList.remove('hidden');
            }

            function handleAnswer(selectedIndex) {
                // ... (Logic xử lý nút bấm, isCorrect) ...
                for (let btn of quizOptionBtns) { btn.disabled = true; }
                const isCorrect = (selectedIndex === currentCorrectAnswerIndex);
                quizOptionBtns[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
                document.getElementById('quiz-explanation').classList.remove('hidden');

                if (isCorrect) {
                    if(currentLevelRef) currentLevelRef.playSound('coin'); 
                    document.getElementById('quiz-continue-btn').classList.remove('hidden'); 
                } else {
                    // Trả lời sai
                    quizOptionBtns[currentCorrectAnswerIndex].classList.add('correct'); 
                    
                    // **ÁP DỤNG PHẠT THỜI GIAN VÀ TRỪ MẠNG**
                    window.applyTimePenalty(); 
                    
                    if (currentMarioRef && !currentMarioRef.dead) {
                        currentMarioRef.hurt(null);
                        
                        // Nếu hết mạng HOẶC hết giờ sau khi phạt
                        if (currentMarioRef.lifes < 0 || gameTimeRemaining <= 0) { 
                             // Game Over sẽ được Level.tick() hoặc Timer xử lý
                             return; 
                        } 
                    }
                    // Cho thử lại sau 2s
                    setTimeout(() => { 
                        document.getElementById('quiz-explanation').classList.add('hidden'); 
                        for (let btn of quizOptionBtns) {
                             btn.disabled = false;
                             btn.className = 'quiz-option-btn'; 
                        }
                    }, 2000); 
                }
            }
            
            // Liên kết lại các nút Quiz
            for (let i = 0; i < quizOptionBtns.length; i++) {
                 quizOptionBtns[i].onclick = () => handleAnswer(i);
            }
            document.getElementById('quiz-continue-btn').onclick = function() {
                 document.getElementById('quiz-overlay').classList.add('hidden');
                 if (currentLevelRef) {
                      keys.bind(); 
                      if (currentMarioRef && !currentMarioRef.dead && !currentLevelRef.loop) { 
                           currentLevelRef.start(); 
                      }
                 }
            };
            

            // --- Game Over/Victory Logic (Sửa lại để dùng Timer/Phạt) ---
            window.handleGameOver = function(isVictory = false) { 
                if (timerInterval) clearInterval(timerInterval); // DỪNG TIMER
                
                // ... (Logic dừng game, nhạc, input cũ) ...
                
                if (isVictory) {
                    const timePlayed = calculateTimePlayed(startTime);
                    
                    document.getElementById('cert-time').innerHTML = `${timePlayed} <strong>Thời gian hoàn thành</strong>`;
                    
                    // ... (Điền tên/MSSV và Hiển thị màn hình chứng nhận) ...

                } else {
                    // Game Over thường
                }
            }
            
            // Khi hoàn thành màn cuối (gọi từ Level.nextLoad trong main.js)
            window.handleGameVictory = function() {
                 window.handleGameOver(true);
            }

            // --- Joystick (Giữ nguyên logic mô phỏng key) ---
            // ... (Logic Joystick cũ, đảm bảo nút Down (40) đã được bind) ...
            // --- Logic UI & Event Handling (Load cuối cùng) ---
// ... (các hàm, biến, DOMContentLoaded cũ) ...

        document.addEventListener('DOMContentLoaded', function() {
            // ... (Khai báo biến DOM, refs, isTouchDevice cũ) ...

            // --- Hàm mô phỏng phím (Key Simulation) ---
            function simulateKey(keyCode, eventType) {
                 var event = new KeyboardEvent(eventType, {
                     'keyCode': keyCode, 'which': keyCode,
                     'bubbles': true, 'cancelable': true
                 });
                 document.dispatchEvent(event);
            }
            
            // --- Joystick Handler (Bind sự kiện cho Mobile) ---
            if (isTouchDevice) {
                 const btnMap = {
                     // KeyCode: 37=Left, 39=Right, 38=Up (Jump), 40=Down (Crouch/Accelerate)
                     'btn-left': 37, 
                     'btn-right': 39, 
                     'btn-jump': 38, 
                     'btn-down': 40 
                 };
                 
                 for (const [id, keyCode] of Object.entries(btnMap)) {
                     const btn = document.getElementById(id);
                     if (btn) {
                         // Dùng { passive: false } để ngăn chặn lỗi trình duyệt khi dùng preventDefault()
                         btn.addEventListener('touchstart', (e) => { 
                             e.preventDefault(); 
                             simulateKey(keyCode, 'keydown'); 
                         }, { passive: false });
                         
                         btn.addEventListener('touchend', (e) => { 
                             e.preventDefault(); 
                             simulateKey(keyCode, 'keyup'); 
                         }, { passive: false });
                     }
                 }
            }

            // ... (các hàm Login Handler, Start Game Button Handler, Quiz Functions, Game Over/Victory Logic còn lại) ...
        }); // End DOMContentLoaded
        }); // End DOMContentLoaded
    </script>
</body>
</html>